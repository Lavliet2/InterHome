name: Build iOS App

on:
  workflow_dispatch:  # Ручной запуск
  push:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build-ios:
    runs-on: macos-latest  # Бесплатные macOS runners в GitHub Actions
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install .NET MAUI workloads
      run: |
        dotnet workload restore
        dotnet workload install maui-ios --skip-sign-check
      working-directory: ${{ github.workspace }}
        
    - name: Restore dependencies
      run: dotnet restore InterHome/InterHome.csproj
      working-directory: ${{ github.workspace }}
      
    - name: Build iOS app for Simulator (no signing required)
      run: |
        dotnet publish InterHome/InterHome.csproj \
          -f net10.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64-simulator \
          -p:BuildIpa=false
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Build iOS app for Device (requires signing - will fail but may create .app)
      run: |
        dotnet publish InterHome/InterHome.csproj \
          -f net10.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=false \
          -p:MtouchExtraArgs="--dev" \
          -p:CodesignProvision="" \
          -p:CodesignKey="" \
          -p:ProvisioningProfile="" \
          -p:CodesignRequireProvisioningProfile=false \
          -p:MtouchUseLlvm=false
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Find build artifacts
      id: find-artifacts
      run: |
        echo "Searching for build artifacts..."
        
        # Search for IPA files
        IPA_PATH=$(find . -name "*.ipa" -type f 2>/dev/null | head -1)
        if [ -n "$IPA_PATH" ]; then
          echo "Found IPA: $IPA_PATH"
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
        fi
        
        # Search for .app bundles in common build locations
        APP_PATHS=$(find . -name "*.app" -type d 2>/dev/null)
        if [ -n "$APP_PATHS" ]; then
          echo "Found .app bundles:"
          echo "$APP_PATHS"
          # Get the first .app bundle
          APP_PATH=$(echo "$APP_PATHS" | head -1)
          echo "Using: $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
        else
          echo "No .app bundles found"
          # List build directories for debugging
          echo "Build directories:"
          find . -type d -name "bin" -o -name "obj" | head -10
        fi
        
        # If nothing found, try to find any iOS build output
        if [ -z "$IPA_PATH" ] && [ -z "$APP_PATH" ]; then
          echo "No artifacts found. Listing iOS build outputs:"
          find InterHome -type d -name "net10.0-ios" 2>/dev/null | head -5
          find InterHome -name "*.dll" -path "*/net10.0-ios/*" 2>/dev/null | head -5
        fi
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Upload IPA artifact
      if: steps.find-artifacts.outputs.ipa_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-ipa
        path: ${{ steps.find-artifacts.outputs.ipa_path }}
        retention-days: 30
        
    - name: Upload APP bundle artifact
      if: steps.find-artifacts.outputs.app_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-bundle
        path: ${{ steps.find-artifacts.outputs.app_path }}
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/bin/**
          **/obj/**
        retention-days: 7