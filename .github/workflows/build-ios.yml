name: Build iOS App

on:
  workflow_dispatch:  # Ручной запуск
  push:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build-ios:
    runs-on: macos-latest  # Бесплатные macOS runners в GitHub Actions
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install .NET MAUI workloads
      run: |
        dotnet workload restore
        dotnet workload install maui-ios --skip-sign-check
      working-directory: ${{ github.workspace }}
        
    - name: Restore dependencies
      run: dotnet restore InterHome/InterHome.csproj
      working-directory: ${{ github.workspace }}
      
    - name: Build iOS app (without signing)
      run: |
        dotnet build InterHome/InterHome.csproj \
          -f net10.0-ios \
          -c Release \
          -p:BuildIpa=true \
          -p:ProvisioningProfile="" \
          -p:CodesignKey="" \
          -p:CodesignProvision="" \
          -p:MtouchExtraArgs="--dev"
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Build iOS app (IPA file)
      run: |
        dotnet publish InterHome/InterHome.csproj \
          -f net10.0-ios \
          -c Release \
          -p:BuildIpa=true \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:ProvisioningProfile="" \
          -p:CodesignKey="" \
          -p:CodesignProvision=""
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Find IPA file
      id: find-ipa
      run: |
        IPA_PATH=$(find . -name "*.ipa" -type f | head -1)
        if [ -z "$IPA_PATH" ]; then
          echo "IPA file not found, trying to find .app bundle"
          APP_PATH=$(find . -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Found .app bundle: $APP_PATH"
            echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          else
            echo "No IPA or APP found"
            exit 1
          fi
        else
          echo "Found IPA: $IPA_PATH"
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
        fi
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Upload IPA artifact
      if: steps.find-ipa.outputs.ipa_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-ipa
        path: ${{ steps.find-ipa.outputs.ipa_path }}
        retention-days: 30
        
    - name: Upload APP bundle artifact
      if: steps.find-ipa.outputs.app_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-bundle
        path: ${{ steps.find-ipa.outputs.app_path }}
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/bin/**
          **/obj/**
        retention-days: 7