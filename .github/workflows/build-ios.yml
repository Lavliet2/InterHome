name: Build iOS App

on:
  workflow_dispatch:  # Ручной запуск
  push:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build-ios-device:
    runs-on: macos-latest  # Бесплатные macOS runners в GitHub Actions
    name: Build for iOS Device (for Sideloadly/iMazing)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install .NET MAUI workloads
      run: |
        dotnet workload restore
        dotnet workload install maui-ios --skip-sign-check
      working-directory: ${{ github.workspace }}
        
    - name: Restore dependencies
      run: dotnet restore InterHome/InterHome.csproj
      working-directory: ${{ github.workspace }}
      
    - name: Build iOS app for Device (ios-arm64)
      id: build-device
      run: |
        echo "Building for iOS Device (ios-arm64) - for Sideloadly/iMazing..."
        echo "Note: This build will be unsigned. Sideloadly/iMazing will sign it during installation."
        
        # Build for real iOS device (not simulator)
        # Use ios-arm64 instead of iossimulator-arm64
        dotnet build InterHome/InterHome.csproj \
          -f net10.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:MtouchLink=SdkOnly \
          -p:MtouchUseLlvm=false \
          -p:CodesignKey="" \
          -p:CodesignProvision="" \
          -p:ProvisioningProfile="" \
          -p:CodesignRequireProvisioningProfile=false \
          -p:_RequireCodeSigning=false \
          -p:MtouchEnableSGenConc=false \
          -v normal 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        # If build succeeds, check for outputs
        if [ "$BUILD_EXIT_CODE" -eq 0 ]; then
          echo "Build succeeded, checking for outputs..."
          # Look for the built app in bin/Release directory
          APP_DIR=$(find InterHome/bin -type d -path "*/net10.0-ios/ios-arm64/*" -name "*.app" 2>/dev/null | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "No .app found in bin, checking obj..."
            APP_DIR=$(find InterHome/obj -type d -path "*/net10.0-ios/ios-arm64/*" -name "*.app" 2>/dev/null | head -1)
          fi
          if [ -n "$APP_DIR" ]; then
            echo "Found .app bundle: $APP_DIR"
          fi
        fi
        
        echo ""
        echo "=== Build Summary ==="
        if [ "$BUILD_EXIT_CODE" -eq 0 ]; then
          echo "✓ Build completed with exit code: $BUILD_EXIT_CODE"
        else
          echo "⚠ Build completed with exit code: $BUILD_EXIT_CODE (may have errors)"
          echo "Last 100 lines of build log:"
          tail -100 build.log || true
        fi
        
        echo ""
        echo "=== Searching for build outputs ==="
        echo "Searching for .app bundles for ios-arm64..."
        find . -name "*.app" -type d 2>/dev/null | grep -E "(ios-arm64|net10.0-ios)" | while read app; do
          echo "Found: $app"
          du -sh "$app" 2>/dev/null || echo "  (size check failed)"
        done
        
        echo ""
        echo "Checking bin directories for ios-arm64:"
        find InterHome/bin -type d -name "*ios-arm64*" 2>/dev/null | head -10
        
        echo ""
        echo "Checking obj directories for ios-arm64:"
        find InterHome/obj -type d -name "*ios-arm64*" 2>/dev/null | head -10
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Verify .app bundle contents
      if: always()
      run: |
        APP_BUNDLE=$(find . -name "*.app" -type d | grep -E "(ios-arm64|net10.0-ios)" | grep -v simulator | head -1)
        if [ -n "$APP_BUNDLE" ]; then
          echo "Found device .app bundle: $APP_BUNDLE"
          echo "Size: $(du -sh "$APP_BUNDLE" | cut -f1)"
          echo "Contents:"
          ls -la "$APP_BUNDLE" | head -10
          if [ -f "$APP_BUNDLE/InterHome" ]; then
            echo "✓ Executable found!"
            ls -lh "$APP_BUNDLE/InterHome"
            file "$APP_BUNDLE/InterHome" || true
          else
            echo "✗ Executable not found"
          fi
        else
          echo "No device .app bundle found"
          echo "Searching all .app bundles:"
          find . -name "*.app" -type d
        fi
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Find build artifacts
      id: find-artifacts
      run: |
        echo "Searching for build artifacts..."
        
        # Search for IPA files
        IPA_PATH=$(find . -name "*.ipa" -type f 2>/dev/null | head -1)
        if [ -n "$IPA_PATH" ]; then
          echo "Found IPA: $IPA_PATH"
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
        fi
        
        # Search for .app bundles, prefer bin/Release directory (final build output)
        echo "Searching for .app bundles..."
        APP_PATHS=$(find . -name "*.app" -type d 2>/dev/null)
        
        if [ -n "$APP_PATHS" ]; then
          echo "Found .app bundles:"
          echo "$APP_PATHS" | while read app; do
            SIZE=$(du -sh "$app" 2>/dev/null | cut -f1)
            echo "  $app ($SIZE)"
          done
          
          # Prefer ios-arm64 builds (for real devices) over simulator builds
          # Exclude codesign subdirectories - they contain incomplete copies
          DEVICE_APP=$(echo "$APP_PATHS" | grep -E "(ios-arm64|net10.0-ios)" | grep -v simulator | grep -v codesign | head -1)
          if [ -n "$DEVICE_APP" ]; then
            APP_PATH="$DEVICE_APP"
            echo "Using device .app bundle: $APP_PATH"
          else
            # Fallback to bin/Release directory
            BIN_APP=$(echo "$APP_PATHS" | grep "bin/Release" | grep -v "codesign" | head -1)
            if [ -n "$BIN_APP" ]; then
              APP_PATH="$BIN_APP"
              echo "Using bin/Release .app bundle: $APP_PATH"
            else
              # Use largest .app bundle (excluding codesign subdirectories)
              APP_PATH=$(echo "$APP_PATHS" | grep -v "codesign" | while read app; do
                SIZE=$(du -sk "$app" 2>/dev/null | cut -f1)
                if [ -n "$SIZE" ] && [ "$SIZE" -gt 0 ]; then
                  echo "$SIZE $app"
                fi
              done | sort -rn | head -1 | cut -d' ' -f2-)
              if [ -n "$APP_PATH" ]; then
                echo "Using largest .app bundle: $APP_PATH"
              else
                # Fallback to any bundle
                APP_PATH=$(echo "$APP_PATHS" | head -1)
                echo "Using first available .app bundle: $APP_PATH"
              fi
            fi
          fi
          
          # Verify it's not empty
          if [ -d "$APP_PATH" ]; then
            SIZE=$(du -sk "$APP_PATH" 2>/dev/null | cut -f1)
            SIZE_MB=$(du -sm "$APP_PATH" 2>/dev/null | cut -f1)
            if [ -n "$SIZE" ] && [ "$SIZE" -gt 0 ]; then
              echo "Bundle size: ${SIZE}KB (${SIZE_MB}MB)"
              if [ "$SIZE" -lt 100 ]; then
                echo "⚠ WARNING: Bundle size is very small ($SIZE KB), may be incomplete"
              else
                echo "✓ Bundle size looks good"
              fi
              echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
            else
              echo "⚠ WARNING: Could not determine bundle size"
            fi
          fi
        else
          echo "No .app bundles found anywhere"
          echo "Listing all build output directories:"
          find InterHome -type d \( -name "bin" -o -name "obj" -o -name "net10.0-ios*" \) 2>/dev/null | head -20
        fi
        
        # If nothing found, try to find any iOS build output
        if [ -z "$IPA_PATH" ] && [ -z "$APP_PATH" ]; then
          echo "No artifacts found. Listing iOS build outputs:"
          find InterHome -type d -name "net10.0-ios" 2>/dev/null | head -5
          find InterHome -name "*.dll" -path "*/net10.0-ios/*" 2>/dev/null | head -5
        fi
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Upload IPA artifact
      if: steps.find-artifacts.outputs.ipa_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-ipa
        path: ${{ steps.find-artifacts.outputs.ipa_path }}
        retention-days: 30
        
    - name: Upload APP bundle artifact (for device)
      if: steps.find-artifacts.outputs.app_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-bundle-device
        path: ${{ steps.find-artifacts.outputs.app_path }}
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/bin/**
          **/obj/**
        retention-days: 7