name: Build iOS App

on:
  workflow_dispatch:  # Ручной запуск
  push:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'InterHome/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build-ios:
    runs-on: macos-latest  # Бесплатные macOS runners в GitHub Actions
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install .NET MAUI workloads
      run: |
        dotnet workload restore
        dotnet workload install maui-ios --skip-sign-check
      working-directory: ${{ github.workspace }}
        
    - name: Restore dependencies
      run: dotnet restore InterHome/InterHome.csproj
      working-directory: ${{ github.workspace }}
      
    - name: Build iOS app for Simulator (no signing required)
      id: build-simulator
      run: |
        echo "Building for iOS Simulator (no code signing needed)..."
        
        # Try build instead of publish for simulator
        # Disable code signing requirement for simulator
        dotnet build InterHome/InterHome.csproj \
          -f net10.0-ios \
          -c Release \
          -p:RuntimeIdentifier=iossimulator-arm64 \
          -p:MtouchExtraArgs="--dev" \
          -p:MtouchLink=SdkOnly \
          -p:MtouchUseLlvm=false \
          -p:CodesignKey="" \
          -p:CodesignProvision="" \
          -p:ProvisioningProfile="" \
          -p:CodesignRequireProvisioningProfile=false \
          -p:_RequireCodeSigning=false \
          -p:MtouchEnableSGenConc=false \
          -v normal 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        # If build succeeds, try to create .app bundle manually
        if [ "$BUILD_EXIT_CODE" -eq 0 ]; then
          echo "Build succeeded, checking for outputs..."
          # Look for the built app in obj directory
          APP_DIR=$(find InterHome/obj -type d -path "*/net10.0-ios/*" -name "*.app" 2>/dev/null | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "No .app found, trying alternative approach..."
            # Try publish with different parameters
            dotnet publish InterHome/InterHome.csproj \
              -f net10.0-ios \
              -c Release \
              -p:RuntimeIdentifier=iossimulator-arm64 \
              -p:_IsPublishing=false \
              -p:MtouchExtraArgs="--dev" \
              -v normal 2>&1 | tee publish.log || true
          fi
        fi
        
        echo ""
        echo "=== Build Summary ==="
        if [ "$BUILD_EXIT_CODE" -eq 0 ]; then
          echo "✓ Build completed with exit code: $BUILD_EXIT_CODE"
        else
          echo "⚠ Build completed with exit code: $BUILD_EXIT_CODE (may have errors)"
          echo "Last 100 lines of build log:"
          tail -100 build.log || true
        fi
        
        echo ""
        echo "=== Searching for build outputs ==="
        echo "Searching for .app bundles in all locations..."
        find . -name "*.app" -type d 2>/dev/null | while read app; do
          echo "Found: $app"
          du -sh "$app" 2>/dev/null || echo "  (size check failed)"
        done
        
        echo ""
        echo "Checking obj directories:"
        find InterHome/obj -type d -name "*simulator*" -o -name "*iossimulator*" 2>/dev/null | head -10
        
        echo ""
        echo "Checking bin directories:"
        find InterHome/bin -type d -name "*simulator*" -o -name "*iossimulator*" 2>/dev/null | head -10
        
        echo ""
        echo "Listing all publish directories:"
        find InterHome -type d -path "*/publish/*" -o -path "*/Release/*" 2>/dev/null | grep -i ios | head -10
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Verify .app bundle contents
      if: always()
      run: |
        APP_BUNDLE=$(find . -name "*.app" -type d | grep -i simulator | head -1)
        if [ -n "$APP_BUNDLE" ]; then
          echo "Found simulator .app bundle: $APP_BUNDLE"
          echo "Size: $(du -sh "$APP_BUNDLE" | cut -f1)"
          echo "Contents:"
          ls -la "$APP_BUNDLE" | head -10
          if [ -f "$APP_BUNDLE/InterHome" ]; then
            echo "✓ Executable found!"
            ls -lh "$APP_BUNDLE/InterHome"
          else
            echo "✗ Executable not found"
          fi
        else
          echo "No simulator .app bundle found"
          echo "Searching all .app bundles:"
          find . -name "*.app" -type d
        fi
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Find build artifacts
      id: find-artifacts
      run: |
        echo "Searching for build artifacts..."
        
        # Search for IPA files
        IPA_PATH=$(find . -name "*.ipa" -type f 2>/dev/null | head -1)
        if [ -n "$IPA_PATH" ]; then
          echo "Found IPA: $IPA_PATH"
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
        fi
        
        # Search for .app bundles, prefer bin/Release directory (final build output)
        echo "Searching for .app bundles..."
        APP_PATHS=$(find . -name "*.app" -type d 2>/dev/null)
        
        if [ -n "$APP_PATHS" ]; then
          echo "Found .app bundles:"
          echo "$APP_PATHS" | while read app; do
            SIZE=$(du -sh "$app" 2>/dev/null | cut -f1)
            echo "  $app ($SIZE)"
          done
          
          # Prefer bin/Release directory (final build output, usually largest)
          BIN_APP=$(echo "$APP_PATHS" | grep "bin/Release" | head -1)
          if [ -n "$BIN_APP" ]; then
            APP_PATH="$BIN_APP"
            echo "Using bin/Release .app bundle: $APP_PATH"
          else
            # Prefer simulator builds
            SIMULATOR_APP=$(echo "$APP_PATHS" | grep -iE "(simulator|sim|iossimulator)" | head -1)
            if [ -n "$SIMULATOR_APP" ]; then
              APP_PATH="$SIMULATOR_APP"
              echo "Using simulator .app bundle: $APP_PATH"
            else
              # Use largest .app bundle
              APP_PATH=$(echo "$APP_PATHS" | while read app; do
                SIZE=$(du -sk "$app" 2>/dev/null | cut -f1)
                echo "$SIZE $app"
              done | sort -rn | head -1 | cut -d' ' -f2-)
              echo "Using largest .app bundle: $APP_PATH"
            fi
          fi
          
          # Verify it's not empty
          if [ -d "$APP_PATH" ]; then
            SIZE=$(du -sk "$APP_PATH" 2>/dev/null | cut -f1)
            SIZE_MB=$(du -sm "$APP_PATH" 2>/dev/null | cut -f1)
            if [ -n "$SIZE" ] && [ "$SIZE" -gt 0 ]; then
              echo "Bundle size: ${SIZE}KB (${SIZE_MB}MB)"
              if [ "$SIZE" -lt 100 ]; then
                echo "⚠ WARNING: Bundle size is very small ($SIZE KB), may be incomplete"
              else
                echo "✓ Bundle size looks good"
              fi
              echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
            else
              echo "⚠ WARNING: Could not determine bundle size"
            fi
          fi
        else
          echo "No .app bundles found anywhere"
          echo "Listing all build output directories:"
          find InterHome -type d \( -name "bin" -o -name "obj" -o -name "net10.0-ios*" \) 2>/dev/null | head -20
        fi
        
        # If nothing found, try to find any iOS build output
        if [ -z "$IPA_PATH" ] && [ -z "$APP_PATH" ]; then
          echo "No artifacts found. Listing iOS build outputs:"
          find InterHome -type d -name "net10.0-ios" 2>/dev/null | head -5
          find InterHome -name "*.dll" -path "*/net10.0-ios/*" 2>/dev/null | head -5
        fi
      working-directory: ${{ github.workspace }}
      continue-on-error: true
      
    - name: Upload IPA artifact
      if: steps.find-artifacts.outputs.ipa_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-ipa
        path: ${{ steps.find-artifacts.outputs.ipa_path }}
        retention-days: 30
        
    - name: Upload APP bundle artifact
      if: steps.find-artifacts.outputs.app_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-bundle
        path: ${{ steps.find-artifacts.outputs.app_path }}
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/bin/**
          **/obj/**
        retention-days: 7